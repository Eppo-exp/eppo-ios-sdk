# Precomputed Client: Stacked Branches Implementation Plan

## Overview
Split the large precomputed client implementation into 3 logical, reviewable branches:
1. Models & Storage (Foundation)
2. Offline Client (Complete offline functionality - assignment logic + initialization)  
3. Network & Online Client (Complete online functionality)

## Branch Structure & Dependencies

```
main
 └── sameerank/FFL-1459-Precomputed-flags-support-models-and-storage
      └── sameerank/FFL-1459-Precomputed-flags-support-offline-client
           └── sameerank/FFL-1459-Precomputed-flags-support-network
```

## Branch 1: Models & Storage
**Branch**: `sameerank/FFL-1459-Precomputed-flags-support-models-and-storage`
**Base**: `main`
**Size**: ~300-400 lines

### Files to Include:
```
Sources/eppo/precomputed/PrecomputedFlag.swift
Sources/eppo/precomputed/PrecomputedConfiguration.swift  
Sources/eppo/precomputed/PrecomputedConfigurationStore.swift
Tests/eppo/precomputed/PrecomputedConfigurationTests.swift
Tests/eppo/precomputed/PrecomputedConfigurationStoreTests.swift
```

### What This Branch Provides:
- ✅ Core data models (PrecomputedFlag, PrecomputedConfiguration)
- ✅ Storage layer (PrecomputedConfigurationStore)
- ✅ Basic JSON encoding/decoding
- ✅ Thread-safe configuration storage
- ✅ Foundation for everything else

### Dependencies: None (builds on main)

## Branch 2: Offline Client (Complete Offline Functionality)
**Branch**: `sameerank/FFL-1459-Precomputed-flags-support-offline-client`
**Base**: Branch 1
**Size**: ~700-800 lines

### Files to Include:
```
Sources/eppo/precomputed/EppoPrecomputedClient.swift (complete offline functionality)
Tests/eppo/precomputed/EppoPrecomputedClientAssignmentTests.swift
Tests/eppo/precomputed/EppoPrecomputedClientPerformanceTests.swift
Tests/eppo/precomputed/EppoPrecomputedClientBasicPerformanceTests.swift
Tests/eppo/precomputed/EppoPrecomputedClientInitializationTests.swift (offline tests only)
Tests/eppo/precomputed/EppoPrecomputedClientErrorTests.swift (offline error scenarios)
```

### What This Branch Adds:
- ✅ Complete EppoPrecomputedClient singleton structure  
- ✅ All 5 assignment methods (getString, getBoolean, etc.)
- ✅ initializeOffline() method
- ✅ Thread-safe singleton initialization with NSLock
- ✅ MD5 hashing with salt for flag lookups
- ✅ Base64 encoding/decoding for obfuscated values
- ✅ Type validation and conversion
- ✅ Assignment logging with deduplication
- ✅ Assignment cache integration  
- ✅ Configuration change callbacks
- ✅ Queued assignment flushing
- ✅ Performance validation (~0.09ms average)
- ✅ Complete offline workflow end-to-end

### Excluded from This Branch:  
- ❌ No online initialization
- ❌ No network components (PrecomputedRequestor)
- ❌ No async initialize() method

### Dependencies: Branch 1 (needs models & storage)

### Why This Combination Makes Sense:
- ✅ **Complete testable functionality** - offline client is fully usable
- ✅ **No throwaway work** - everything added is part of final implementation  
- ✅ **Meaningful for users** - provides complete offline precomputed client
- ✅ **Easier testing** - can test assignment methods through real initialization
- ✅ **Single coherent feature** - "offline precomputed client"

## Branch 3: Network & Online Client  
**Branch**: `sameerank/FFL-1459-Precomputed-flags-support-network`
**Base**: Branch 2
**Size**: ~400-500 lines

### Files to Add/Modify:
```
Sources/eppo/precomputed/PrecomputedRequestor.swift
Sources/eppo/precomputed/EppoPrecomputedClient.swift (add initialize() method)
Tests/eppo/precomputed/EppoPrecomputedClientInitializationTests.swift (add online tests when mocking ready)
```

### What This Branch Adds:
- ✅ PrecomputedRequestor (network layer)
- ✅ initialize() async method
- ✅ Network error handling with retries
- ✅ Online configuration fetching
- ✅ Complete online workflow end-to-end

### Tests That Need to Be Added in Branch 3:
- ✅ testQueuedAssignmentsBeforeLoggerIsSet - Test assignment queuing when no logger is set during initialization
- ✅ Performance test suite:
  - testSingleAssignmentPerformance - Measure single assignment speed
  - testAssignmentPerformanceUnder1ms - Verify <1ms requirement with 1000 assignments  
  - testConcurrentAssignmentPerformance - Test concurrent assignment performance
  - testInitializationPerformance - Benchmark initialization with different config sizes
  - testMemoryUsageWithLargeConfiguration - Memory usage testing with 1000 flags
  - testDifferentAssignmentTypesPerformance - Performance across all assignment types
- ✅ Online initialization tests (currently disabled)
- ✅ Network mocking and retry logic tests

### Dependencies: Branches 1 & 2 (needs models + offline client for complete implementation)

## Implementation Steps

### Step 1: Create Branch 1 (Models & Storage)
```bash
# Create new branch off main
git checkout main
git pull origin main
git checkout -b sameerank/FFL-1459-Precomputed-flags-support-models-and-storage

# Copy model files from current branch
git checkout sameerank/FFL-1459-Precomputed-flags-support -- Sources/eppo/precomputed/PrecomputedFlag.swift
git checkout sameerank/FFL-1459-Precomputed-flags-support -- Sources/eppo/precomputed/PrecomputedConfiguration.swift  
git checkout sameerank/FFL-1459-Precomputed-flags-support -- Sources/eppo/precomputed/PrecomputedConfigurationStore.swift
git checkout sameerank/FFL-1459-Precomputed-flags-support -- Tests/eppo/precomputed/PrecomputedConfigurationTests.swift
git checkout sameerank/FFL-1459-Precomputed-flags-support -- Tests/eppo/precomputed/PrecomputedConfigurationStoreTests.swift

# Test and commit
swift test --filter "PrecomputedConfiguration"
git add .
git commit -m "feat: add precomputed client foundation models and storage"
git push origin sameerank/FFL-1459-Precomputed-flags-support-models-and-storage
```

### Step 2: Create Branch 2 (Offline Client)
```bash
# Create new branch off branch 1
git checkout sameerank/FFL-1459-Precomputed-flags-support-models-and-storage
git checkout -b sameerank/FFL-1459-Precomputed-flags-support-offline-client

# Copy complete offline client implementation
git checkout sameerank/FFL-1459-Precomputed-flags-support -- Sources/eppo/precomputed/EppoPrecomputedClient.swift
git checkout sameerank/FFL-1459-Precomputed-flags-support -- Tests/eppo/precomputed/EppoPrecomputedClientAssignmentTests.swift
git checkout sameerank/FFL-1459-Precomputed-flags-support -- Tests/eppo/precomputed/EppoPrecomputedClientPerformanceTests.swift
git checkout sameerank/FFL-1459-Precomputed-flags-support -- Tests/eppo/precomputed/EppoPrecomputedClientBasicPerformanceTests.swift
git checkout sameerank/FFL-1459-Precomputed-flags-support -- Tests/eppo/precomputed/EppoPrecomputedClientInitializationTests.swift
git checkout sameerank/FFL-1459-Precomputed-flags-support -- Tests/eppo/precomputed/EppoPrecomputedClientErrorTests.swift

# Remove online-only components (manual editing required - see below)
# Test and commit  
swift test --filter "EppoPrecomputedClient"
git add .
git commit -m "feat: add complete offline precomputed client with assignment logic and initialization"
git push origin sameerank/FFL-1459-Precomputed-flags-support-offline-client
```

### Step 3: Create Branch 3 (Network & Online)
```bash
# Create new branch off branch 2  
git checkout sameerank/FFL-1459-Precomputed-flags-support-offline-client
git checkout -b sameerank/FFL-1459-Precomputed-flags-support-network

# Add network components
git checkout sameerank/FFL-1459-Precomputed-flags-support -- Sources/eppo/precomputed/PrecomputedRequestor.swift

# Add online initialization to EppoPrecomputedClient.swift (manual editing required)
# Test and commit
swift test --filter "Online"
git add .
git commit -m "feat: add network layer and online initialization"
git push origin sameerank/FFL-1459-Precomputed-flags-support-network
```

## Manual Editing Required

### Branch 2: Remove Online Components
Need to edit EppoPrecomputedClient.swift to remove:
- ❌ Remove initialize() async method (keep only initializeOffline())
- ❌ Remove PrecomputedRequestor references  
- ❌ Remove network-related imports
- ❌ Disable online initialization tests (prefix with `_`)

### Branch 3: Add Network & Online Components
Add back to EppoPrecomputedClient.swift:
- ✅ Add initialize() async method
- ✅ Add PrecomputedRequestor usage
- ✅ Add network error handling
- ✅ Enable online initialization tests

## Testing Strategy
- Branch 1: Test models and storage only
- Branch 2: Test complete offline client functionality (assignment logic + offline initialization)
- Branch 3: Test online initialization (when mocking ready)

## PR Review Order
1. Models & Storage PR (~300-400 lines, foundational)
2. Offline Client PR (~700-800 lines, complete offline functionality)
3. Network & Online PR (~400-500 lines, complete implementation)

Each PR builds on the previous, making review easier and safer.

## Benefits of This Approach
- ✅ Smaller, focused PRs (~300-600 lines each vs 2000+ lines)
- ✅ Logical progression that's easy to review
- ✅ Can test and validate each layer before adding complexity
- ✅ Easier to rollback specific layers if issues found
- ✅ Parallelizable - can start next PR review while previous is being finalized
- ✅ Reduced risk of conflicts and merge issues